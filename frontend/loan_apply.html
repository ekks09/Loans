<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apply for Loan - MicroLoan</title>
    <link rel="stylesheet" href="styles/main.css">
    <link rel="stylesheet" href="styles/glass.css">
    <link rel="stylesheet" href="styles/animations.css">
</head>
<body>
    <div class="gradient-bg"></div>
    <div class="floating-shapes">
        <div class="shape shape-1"></div>
        <div class="shape shape-2"></div>
        <div class="shape shape-3"></div>
    </div>

    <nav class="glass-nav">
        <div class="nav-brand">
            <span class="logo">ML</span>
            <span class="brand-name">MicroLoan</span>
        </div>
        <div class="nav-links">
            <a href="dashboard.html" class="nav-link">Dashboard</a>
            <button id="logout-btn" class="btn btn-secondary">Logout</button>
        </div>
    </nav>

    <main class="apply-container">
        <div class="apply-header">
            <h1>Apply for a Loan</h1>
            <p>Your current limit: <span id="user-limit" class="highlight">KES 5,000</span></p>
        </div>

        <div class="apply-content">
            <div class="loan-calculator glass-card float-animation">
                <h2>Select Loan Amount</h2>
                
                <div class="slider-container">
                    <input type="range" id="loan-slider" min="3000" max="60000" step="1000" value="5000">
                    <div class="slider-labels">
                        <span>KES 3,000</span>
                        <span>KES 60,000</span>
                    </div>
                </div>

                <div class="amount-display">
                    <span class="amount-label">Loan Amount</span>
                    <span class="amount-value" id="display-amount">KES 5,000</span>
                </div>

                <div class="preset-amounts">
                    <button class="preset-btn" data-amount="3000">3K</button>
                    <button class="preset-btn" data-amount="5000">5K</button>
                    <button class="preset-btn" data-amount="10000">10K</button>
                    <button class="preset-btn" data-amount="20000">20K</button>
                    <button class="preset-btn" data-amount="30000">30K</button>
                    <button class="preset-btn" data-amount="50000">50K</button>
                </div>
            </div>

            <div class="loan-preview glass-card float-animation-delayed">
                <h2>Loan Preview</h2>
                
                <div class="preview-details">
                    <div class="preview-row">
                        <span class="preview-label">Principal</span>
                        <span class="preview-value" id="preview-principal">KES 5,000</span>
                    </div>
                    <div class="preview-row">
                        <span class="preview-label">Processing Fee</span>
                        <span class="preview-value" id="preview-fee">KES 350</span>
                    </div>
                    <div class="preview-row total">
                        <span class="preview-label">Total Repayable</span>
                        <span class="preview-value" id="preview-total">KES 5,350</span>
                    </div>
                </div>

                <div class="error-message" id="apply-error"></div>

                <button id="apply-btn" class="btn btn-primary btn-full pulse-animation">Apply Now</button>
            </div>
        </div>
    </main>

    <div id="receipt-modal" class="modal">
        <div class="modal-content glass-card receipt-card">
            <div class="receipt-header">
                <div class="receipt-icon">&#9989;</div>
                <h2>Loan Approved!</h2>
            </div>
            <div class="receipt-body">
                <div class="receipt-row">
                    <span>Loan ID</span>
                    <span id="receipt-id">#1</span>
                </div>
                <div class="receipt-row">
                    <span>Principal</span>
                    <span id="receipt-principal">KES 5,000</span>
                </div>
                <div class="receipt-row">
                    <span>Processing Fee</span>
                    <span id="receipt-fee">KES 350</span>
                </div>
                <div class="receipt-row total">
                    <span>Total to Repay</span>
                    <span id="receipt-total">KES 5,350</span>
                </div>
            </div>
            <div class="receipt-actions">
                <a href="dashboard.html" class="btn btn-primary">Go to Dashboard</a>
            </div>
        </div>
    </div>

    <script src="scripts/api.js"></script>
    <script src="scripts/ui.js"></script>
    <script>
        const FEE_STRUCTURE = {
            3000: 200,
            5000: 350,
            6000: 460,
            7000: 460,
            8000: 460,
            10000: 1000,
            20000: 2000,
            30000: 3000,
            40000: 4000,
            50000: 5000,
            60000: 6000
        };

        function calculateFee(principal) {
            if (FEE_STRUCTURE[principal]) {
                return FEE_STRUCTURE[principal];
            }
            if (principal >= 6000 && principal <= 8000) {
                return 460;
            }
            const amounts = Object.keys(FEE_STRUCTURE).map(Number).sort((a, b) => a - b);
            for (let i = 0; i < amounts.length; i++) {
                if (principal < amounts[i]) {
                    return FEE_STRUCTURE[amounts[i > 0 ? i - 1 : 0]];
                }
            }
            return FEE_STRUCTURE[60000];
        }

        let userLimit = 5000;

        document.addEventListener('DOMContentLoaded', async function() {
            if (!API.isAuthenticated()) {
                window.location.href = 'login.html';
                return;
            }

            try {
                const data = await API.getLoanHistory();
                userLimit = data.loan_limit;
                document.getElementById('user-limit').textContent = `KES ${userLimit.toLocaleString()}`;
                
                const slider = document.getElementById('loan-slider');
                slider.max = userLimit;
                if (parseInt(slider.value) > userLimit) {
                    slider.value = userLimit;
                }
                updatePreview();
            } catch (error) {
                console.error('Failed to load user data:', error);
            }

            document.getElementById('logout-btn').addEventListener('click', function() {
                localStorage.removeItem('access_token');
                localStorage.removeItem('refresh_token');
                window.location.href = 'login.html';
            });
        });

        const slider = document.getElementById('loan-slider');
        slider.addEventListener('input', updatePreview);

        document.querySelectorAll('.preset-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const amount = parseInt(this.dataset.amount);
                if (amount <= userLimit) {
                    slider.value = amount;
                    updatePreview();
                } else {
                    alert(`Amount exceeds your limit of KES ${userLimit.toLocaleString()}`);
                }
            });
        });

        function updatePreview() {
            const principal = parseInt(slider.value);
            const fee = calculateFee(principal);
            const total = principal + fee;

            document.getElementById('display-amount').textContent = `KES ${principal.toLocaleString()}`;
            document.getElementById('preview-principal').textContent = `KES ${principal.toLocaleString()}`;
            document.getElementById('preview-fee').textContent = `KES ${fee.toLocaleString()}`;
            document.getElementById('preview-total').textContent = `KES ${total.toLocaleString()}`;
        }

        document.getElementById('apply-btn').addEventListener('click', async function() {
            const amount = parseInt(slider.value);
            const errorDiv = document.getElementById('apply-error');
            
            if (amount > userLimit) {
                errorDiv.textContent = `Amount exceeds your limit of KES ${userLimit.toLocaleString()}`;
                errorDiv.style.display = 'block';
                return;
            }

            try {
                const result = await API.applyLoan(amount);
                
                document.getElementById('receipt-id').textContent = `#${result.id}`;
                document.getElementById('receipt-principal').textContent = `KES ${result.amount.toLocaleString()}`;
                document.getElementById('receipt-fee').textContent = `KES ${result.fee.toLocaleString()}`;
                document.getElementById('receipt-total').textContent = `KES ${result.total.toLocaleString()}`;
                
                document.getElementById('receipt-modal').style.display = 'flex';
            } catch (error) {
                errorDiv.textContent = error.message || 'Loan application failed. Please try again.';
                errorDiv.style.display = 'block';
            }
        });
    </script>
</body>
</html>
