<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apply for Loan - MicroLoan</title>
    <link rel="stylesheet" href="styles/main.css">
    <link rel="stylesheet" href="styles/glass.css">
    <link rel="stylesheet" href="styles/animations.css">
</head>
<body>
    <div class="gradient-bg"></div>
    <div class="floating-shapes">
        <div class="shape shape-1"></div>
        <div class="shape shape-2"></div>
        <div class="shape shape-3"></div>
    </div>

    <nav class="glass-nav">
        <div class="nav-brand">
            <span class="logo">ML</span>
            <span class="brand-name">MicroLoan</span>
        </div>
        <div class="nav-links">
            <a href="dashboard.html" class="nav-link">‚Üê Back to Dashboard</a>
            <button id="logout-btn" class="btn btn-secondary">Logout</button>
        </div>
    </nav>

    <main class="loan-apply-container">
        <div class="loan-apply-card glass-card">
            <div class="apply-header">
                <h1>Apply for a Loan</h1>
                <p>Get instant access to funds up to your limit</p>
            </div>

            <div class="loan-limits glass-card">
                <div class="limit-info">
                    <span class="limit-label">Your Current Limit</span>
                    <span class="limit-value" id="user-limit">KES 5,000</span>
                </div>
                <div class="limit-info">
                    <span class="limit-label">Max Loan Amount</span>
                    <span class="limit-value" id="max-amount">KES 5,000</span>
                </div>
            </div>

            <form id="loan-form">
                <div class="form-group">
                    <label for="loan-amount">Loan Amount (KES)</label>
                    <input 
                        type="number" 
                        id="loan-amount" 
                        name="amount" 
                        min="3000" 
                        max="60000" 
                        step="1000"
                        placeholder="Enter amount (3,000 - 60,000)"
                        required
                    >
                    <small>Minimum: KES 3,000 | Maximum: KES 60,000</small>
                </div>

                <div class="loan-preview glass-card" id="loan-preview" style="display: none;">
                    <h3>Loan Preview</h3>
                    <div class="preview-row">
                        <span class="preview-label">Principal Amount</span>
                        <span class="preview-value" id="preview-principal">KES 0</span>
                    </div>
                    <div class="preview-row">
                        <span class="preview-label">Service Fee</span>
                        <span class="preview-value" id="preview-fee">KES 0</span>
                    </div>
                    <div class="preview-row highlight">
                        <span class="preview-label">Total Repayable</span>
                        <span class="preview-value" id="preview-total">KES 0</span>
                    </div>
                    <div class="preview-row">
                        <span class="preview-label">Loan Duration</span>
                        <span class="preview-value" id="preview-duration">30 Days</span>
                    </div>
                </div>

                <div id="form-error" class="error-message" style="display: none;"></div>
                <div id="form-success" class="success-message" style="display: none;"></div>

                <button type="submit" class="btn btn-primary btn-full">Apply for Loan</button>
                <a href="dashboard.html" class="btn btn-secondary btn-full">Cancel</a>
            </form>

            <div class="loan-info">
                <h3>Fee Structure</h3>
                <div class="fee-table">
                    <div class="fee-row">
                        <span class="fee-amount">3,000 - 5,000 KES</span>
                        <span class="fee-percent">200 - 350 KES</span>
                    </div>
                    <div class="fee-row">
                        <span class="fee-amount">6,000 - 8,000 KES</span>
                        <span class="fee-percent">460 KES</span>
                    </div>
                    <div class="fee-row">
                        <span class="fee-amount">10,000 KES</span>
                        <span class="fee-percent">1,000 KES</span>
                    </div>
                    <div class="fee-row">
                        <span class="fee-amount">20,000 KES</span>
                        <span class="fee-percent">2,000 KES</span>
                    </div>
                    <div class="fee-row">
                        <span class="fee-amount">30,000 KES</span>
                        <span class="fee-percent">3,000 KES</span>
                    </div>
                    <div class="fee-row">
                        <span class="fee-amount">40,000 KES</span>
                        <span class="fee-percent">4,000 KES</span>
                    </div>
                    <div class="fee-row">
                        <span class="fee-amount">50,000 KES</span>
                        <span class="fee-percent">5,000 KES</span>
                    </div>
                    <div class="fee-row">
                        <span class="fee-amount">60,000 KES</span>
                        <span class="fee-percent">6,000 KES</span>
                    </div>
                </div>
            </div>

            <div class="loan-terms">
                <h3>Terms & Conditions</h3>
                <ul>
                    <li>Loan duration is fixed at 30 days</li>
                    <li>You must repay the total amount (principal + fee) within 30 days</li>
                    <li>Late repayment may affect your future loan limits</li>
                    <li>Your loan limit increases by KES 2,000 after successful repayment (up to KES 60,000 maximum)</li>
                    <li>Approved loans appear instantly in your dashboard</li>
                </ul>
            </div>
        </div>
    </main>

    <script src="scripts/api.js"></script>
    <script src="scripts/ui.js"></script>
    <script>
        const loanAmountInput = document.getElementById('loan-amount');
        const loanForm = document.getElementById('loan-form');
        const loanPreview = document.getElementById('loan-preview');
        const errorDiv = document.getElementById('form-error');
        const successDiv = document.getElementById('form-success');
        let userLoanLimit = 5000;

        document.addEventListener('DOMContentLoaded', async function() {
            if (!API.isAuthenticated()) {
                window.location.href = 'login.html';
                return;
            }

            // Load user loan limit
            try {
                const userData = await API.getLoanHistory();
                userLoanLimit = userData.loan_limit;
                document.getElementById('user-limit').textContent = `KES ${userLoanLimit.toLocaleString()}`;
                document.getElementById('max-amount').textContent = `KES ${userLoanLimit.toLocaleString()}`;
                loanAmountInput.max = userLoanLimit;
            } catch (error) {
                console.error('Failed to load user data:', error);
            }

            // Logout button
            document.getElementById('logout-btn').addEventListener('click', function() {
                localStorage.removeItem('access_token');
                localStorage.removeItem('refresh_token');
                window.location.href = 'login.html';
            });

            // Loan amount input change - show preview
            loanAmountInput.addEventListener('change', async function() {
                const amount = parseInt(this.value);
                if (amount >= 3000 && amount <= userLoanLimit) {
                    await showLoanPreview(amount);
                } else if (amount > userLoanLimit) {
                    showError(`Amount exceeds your limit of KES ${userLoanLimit.toLocaleString()}`);
                    loanPreview.style.display = 'none';
                }
            });

            loanAmountInput.addEventListener('input', async function() {
                const amount = parseInt(this.value);
                if (!isNaN(amount) && amount >= 3000 && amount <= userLoanLimit) {
                    await showLoanPreview(amount);
                }
            });

            // Form submission
            loanForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                const amount = parseInt(loanAmountInput.value);

                if (!amount || amount < 3000 || amount > userLoanLimit) {
                    showError('Invalid loan amount. Please check your input.');
                    return;
                }

                await submitLoanApplication(amount);
            });
        });

        async function showLoanPreview(amount) {
            try {
                const preview = await API.getLoanPreview(amount);
                
                document.getElementById('preview-principal').textContent = `KES ${preview.principal.toLocaleString()}`;
                document.getElementById('preview-fee').textContent = `KES ${preview.fee.toLocaleString()}`;
                document.getElementById('preview-total').textContent = `KES ${preview.total_repayable.toLocaleString()}`;
                document.getElementById('preview-duration').textContent = '30 Days';
                
                loanPreview.style.display = 'block';
                hideError();
            } catch (error) {
                console.error('Failed to preview loan:', error);
                loanPreview.style.display = 'none';
            }
        }

        async function submitLoanApplication(amount) {
            try {
                // Show loading state
                const submitBtn = loanForm.querySelector('button[type="submit"]');
                const originalText = submitBtn.textContent;
                submitBtn.disabled = true;
                submitBtn.textContent = 'Processing...';

                const loan = await API.applyLoan(amount);

                // Show success message
                showSuccess(`Loan approved! Loan ID: #${loan.id}`);
                
                // Reset form
                loanForm.reset();
                loanPreview.style.display = 'none';

                // Redirect to dashboard after 2 seconds
                setTimeout(() => {
                    window.location.href = `dashboard.html`;
                }, 2000);
            } catch (error) {
                showError(error.message || 'Failed to apply for loan');
                const submitBtn = loanForm.querySelector('button[type="submit"]');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Apply for Loan';
            }
        }

        function showError(message) {
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            successDiv.style.display = 'none';
        }

        function hideError() {
            errorDiv.style.display = 'none';
        }

        function showSuccess(message) {
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            errorDiv.style.display = 'none';
        }
    </script>
</body>
</html>
